<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Canvas tutorial template</title>
    <script type="text/javascript">
      
      //0: wall
      //1: can walk
      //2: grass
      //3: treasure
      //4: another stage
      var stage1 = [
      [ 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 3, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ]
      ];
      
      var stage2 = [
      [ 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0 ],
      [ 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 4, 0, 0, 0, 0, 0, 0, 0, 0 ]
      ];
      
      var nstage_x = 15; //y書き換え
      var nstage_y = 20; //x書き換え
      var interval = 32;
      var chara_x = 17;
      var chara_y = 12;
      var chara_size = 32;
      var stage = stage1;

      function drawStage( ctx, stage ){
      for( var i = 0; i < nstage_y; i++ ){
	for( var j = 0; j < nstage_x; j++ ){
          if( stage[j][i] == 0 ) ctx.fillStyle = 'rgb(71, 131, 40)';
	  else if( stage[j][i] == 1 || stage[j][i] == 4) ctx.fillStyle = 'rgb(154, 76, 44)';
	  else if( stage[j][i] == 2 ) ctx.fillStyle = 'rgb(0, 76, 44)';
	  else if( stage[j][i] == 3 ) ctx.fillStyle = 'rgb(255, 246, 71)';
          else if( stage[j][i] == 4 ) {console.log(stage[j][i]); ctx.fillStyle = 'rgb(0, 0, 0)';}
	  ctx.fillRect( i*interval, j*interval, interval, interval);
        }
      }
      }
      
      function drawBlack( ctx ){
      for( var i = 0; i < nstage_y; i++ ){
	for( var j = 0; j < nstage_x; j++ ){
          ctx.fillStyle = 'rgb(0, 0, 0)';
	  ctx.fillRect( i*interval, j*interval, interval, interval);
        }
      }
      }

      document.onkeydown = keydown;
      
      function keydown() {

      if(event.keyCode == 38){ //up
      if(stage[chara_y-1][chara_x] == 1 || stage[chara_y-1][chara_x] == 2 ){
      ctx.clearRect( chara_x*interval, chara_y*interval, interval, interval);
      drawStage(ctx, stage);
      chara_y--; 
      }else if(stage[chara_y-1][chara_x] == 4){
      stage = stage2;
      drawStage(ctx, stage);
      chara_x = 9;
      chara_y = 14;
      }
      }
      if(event.keyCode == 40){ //down
      if(stage[chara_y+1][chara_x] == 1 || stage[chara_y+1][chara_x] == 2 ){
      ctx.clearRect( chara_x*interval, chara_y*interval, interval, interval);
      drawStage(ctx,stage);
      chara_y++; 
      }else if(stage[chara_y+1][chara_x] == 4 ){
      stage = stage1;
      drawStage(ctx, stage);
      chara_y = 1;
      }
      }
      if(event.keyCode == 39){ //right
      if(stage[chara_y][chara_x+1] == 1 || stage[chara_y][chara_x+1] == 2 ){
      ctx.clearRect( chara_x*interval, chara_y*interval, interval, interval);
      drawStage(ctx,stage);
      chara_x++; 
      }
      }
      if(event.keyCode == 37){  //left
      if(stage[chara_y][chara_x-1] != 0){
      ctx.clearRect( chara_x*interval, chara_y*interval, interval, interval);
      drawStage(ctx,stage);
      chara_x--;
      }
      }
      console.log(chara_x,chara_y);
      ctx.fillStyle = 'rgb(255, 0, 0)';
      ctx.fillRect( chara_x*interval, chara_y*interval, interval, interval);
      }

      
      function init(){
      var canvas = document.getElementById('canvas');
      if (canvas.getContext){
      ctx = canvas.getContext('2d');
      drawStage(ctx, stage);
      ctx.fillStyle = 'rgb(255, 0, 0)';
      ctx.fillRect( chara_x*interval, chara_y*interval, interval, interval);
      
      }
      }



      function update(){
      canvas.width = canvas.width;  //画面更新の裏技
      }
      
    </script>
    <style type="text/css">
      canvas { border: 1px solid #000; }
    </style>
  </head>
  <body onload="init()">
    <canvas id="canvas" width="640" height="480"></canvas>
    <div id="message"></div>
  </body>
</html>
